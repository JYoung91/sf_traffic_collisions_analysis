---
title: "traffic_collisions_sf"
author: "Jeremie Young"
date: "November 6, 2018"
output: html_document
---

# load accident dataset as CSV file
```{r}
library(readr)
CollisionRecords <- read_csv("C:/Users/Jeremie/Google Drive/Springboard Intro to Data Science/Capstone/Raw Datasets/CollisionRecords2010_2018.txt")
head(CollisionRecords)

```

# import both dplyr and tidyr packages to use
```{r}
library(dplyr)
library(tidyr)
```


# subset dataframe by removing unused variables
```{r}
CollisionRecords <- CollisionRecords %>% 
             select(-JURIS, -OFFICER_ID, -REPORTING_DISTRICT, -CHP_SHIFT, -POPULATION, -CNTY_CITY_LOC, -SPECIAL_COND, -BEAT_TYPE, -CHP_BEAT_TYPE, -CITY_DIVISION_LAPD, -CHP_BEAT_CLASS, -BEAT_NUMBER, -WEATHER_2, -STATE_HWY_IND, -CALTRANS_COUNTY, -CALTRANS_DISTRICT, -STATE_ROUTE, -ROUTE_SUFFIX, -POSTMILE_PREFIX, -POSTMILE, -RAMP_INTERSECTION, -SIDE_OF_HWY, -TOW_AWAY, -PCF_VIOLATION, -CHP_ROAD_TYPE, -LATITUDE, -LONGITUDE)
head(CollisionRecords)

```

# begin geocoding coordinate extraction process - concatenate/unite cross streets
```{r}
CollisionRecords <- CollisionRecords %>% 
              unite(CROSS_ST, PRIMARY_RD, SECONDARY_RD, sep = " & ")
```

# create new column for city and state to insert into dataframe
```{r}
library(tibble)
CITY <- "SAN FRANCISCO"
STATE <- "CA"
CollisionRecords <- CollisionRecords %>% 
    add_column(CITY, STATE, .after = "CROSS_ST")
```

# subset CASE_ID, CROSS_ST, CITY, STATE as csv export to extract coordinates on https://www.geocod.io/
```{r}
coordinates <- CollisionRecords %>%  
    select(CASE_ID, CROSS_ST:STATE)
write.table(coordinates, "coordinates.csv", row.names = FALSE, sep = ",")

```

# import geocoded sheet with coordinate data
```{r}
coordinates_geocodio <- read_csv("C:/Users/Jeremie/Google Drive/Springboard Intro to Data Science/Capstone/coordinates_geocodio.csv")
head(coordinates_geocodio)
```

# clean out undeliverable records that resulted in missing data (0 for coordinates & accurancy), coordinate accuracy level of less than .7, and incorrect geocoding to San Mateo County
```{r}
coordinates_geocodio <- coordinates_geocodio %>% 
    filter(`Accuracy Score` != 0 & `Accuracy Score` > .7 & County != "San Mateo County")
```

# keep pertinent columns
```{r}
coordinates_geocodio <- coordinates_geocodio %>% 
    select(CASE_ID, Latitude, Longitude, `Accuracy Score`, `Accuracy Type`, Zip)
```

# reinsert into original dataset and remove records
```{r}
CollisionRecords <- full_join(CollisionRecords, coordinates_geocodio, by = "CASE_ID")
```

# remove N/A records
```{r}
CollisionRecords <- CollisionRecords %>% 
    filter(!is.na(`Accuracy Score`))
```

# Update COLLISION_SEVERITY for appropriate scale
```{r}
CollisionRecords <- CollisionRecords %>% 
  mutate(COLLISION_SEVERITY = replace(COLLISION_SEVERITY, COLLISION_SEVERITY == 0, 5))
```

# Update PCF_VIOL_CATEGORY
```{r}
CollisionRecords %>% 
  mutate(
    PCF_VIOL_CATEGORY = replace(PCF_VIOL_CATEGORY, PCF_VIOL_CATEGORY == 00, 0),
    PCF_VIOL_CATEGORY = replace(PCF_VIOL_CATEGORY, PCF_VIOL_CATEGORY == 01, 1),
    PCF_VIOL_CATEGORY = replace(PCF_VIOL_CATEGORY, PCF_VIOL_CATEGORY == 02, 2),
    PCF_VIOL_CATEGORY = replace(PCF_VIOL_CATEGORY, PCF_VIOL_CATEGORY == 03, 3),
    PCF_VIOL_CATEGORY = replace(PCF_VIOL_CATEGORY, PCF_VIOL_CATEGORY == 04, 4),
    PCF_VIOL_CATEGORY = replace(PCF_VIOL_CATEGORY, PCF_VIOL_CATEGORY == 05, 5),
    PCF_VIOL_CATEGORY = replace(PCF_VIOL_CATEGORY, PCF_VIOL_CATEGORY == 06, 6),
    PCF_VIOL_CATEGORY = replace(PCF_VIOL_CATEGORY, PCF_VIOL_CATEGORY == 07, 7),
    PCF_VIOL_CATEGORY = replace(PCF_VIOL_CATEGORY, PCF_VIOL_CATEGORY == 08, 8),
    PCF_VIOL_CATEGORY = replace(PCF_VIOL_CATEGORY, PCF_VIOL_CATEGORY == 09, 9)
  )
```


# create columns that will help label for visualizations
```{r}
# Violation designation
PCF_VIOL_CATEGORY <- c("01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13", "14", "15", "16", "17", "18", "21", "22", "23", "24", "00", "-")
PCF_Violation <- c("Driving or Bicycling Under the Influence of Alcohol or Drug", "Impeding Traffic", "Unsafe Speed", "Following Too Closely", "Wrong Side of Road", "Improper Passing", "Unsafe Lane Change", "Improper Turning", "Automobile Right of Way", "Pedestrian Right of Way", "Pedestrian Violation", "Traffic Signals and Signs", "Hazardous Parking", "Lights", "Brakes", "Other Equipment", "Other Hazardous Violation", "Other Than Driver (or Pedestrian)", "Unsafe Starting or Backing", "Other Improper Driving", "Pedestrian or Other Under the Influence of Alcohol or Drug", "Fell Asleep", "Unknown", "Not Stated")

PCF_Violation_Labels <- data.frame(PCF_VIOL_CATEGORY, PCF_Violation)
PCF_Violation_Labels

# Lighting Conditions
LIGHTING <- c("A", "B", "C", "D", "E", "-")
Light_Condition <- c("Daylight", "Dusk - Dawn", "Dark - Street Lights", "Dark - No Street Lights", "Dark - Street Lights Not Functioning", "Not Stated")

Lighting_Labels <- data.frame(LIGHTING, Light_Condition)
Lighting_Labels

# Road Surface Conditions
ROAD_SURFACE <- c("A", "B", "C", "D", "-")
Road_Surface <- c("Dry", "Wet", "Snowy or Icy", "Slippery (Muddy, Oily, etc.)", "Not Stated")

Road_Surface_Labels <- data.frame(ROAD_SURFACE, Road_Surface)
Road_Surface_Labels

# Pedestrian Action
PED_ACTION <- c("A", "B", "C", "D", "E", "F", "G", "-")
Pedestrian_Action <- c("No Pedestrian Involved", "Crossing in Crosswalk at Intersection", "Crossing in Crosswalk Not at Intersection", "Crossing Not in Crosswalk", "In Road, Including Shoulder", "Not in Road", "Approaching/Leaving School Bus", "Not Stated")

Pedestrian_Action_Labels <- data.frame(PED_ACTION, Pedestrian_Action)
Pedestrian_Action_Labels

# Type of Collision
TYPE_OF_COLLISION <- c("A", "B", "C", "D", "E", "F", "G", "H", "-")
Collision_Type <- c("Head-On", "Sideswipe", "Rear End", "Broadside", "Hit Object", "Overturned", "Vehicle/Pedestrian", "Other", "Not Stated")

Collision_Type_Labels <- data.frame(TYPE_OF_COLLISION, Collision_Type)
Collision_Type_Labels

# Collision Severity
COLLISION_SEVERITY <- c(1, 2, 3, 4, 5)
Collision_Severity <- c("Fatal", "Injury (Severe)", "Injury (Other Visible)", "Injury (Complaint of Pain)", "Property Damage Only")

Collision_Severity_Labels <- data.frame(COLLISION_SEVERITY, Collision_Severity)
Collision_Severity_Labels
```

# left join into main dataframe
```{r}
CollisionRecords <- CollisionRecords %>%  
                      left_join(PCF_Violation_Labels, by = "PCF_VIOL_CATEGORY") %>% 
                      left_join(Lighting_Labels, by = "LIGHTING") %>% 
                      left_join(Road_Surface_Labels, by = "ROAD_SURFACE") %>% 
                      left_join(Pedestrian_Action_Labels, by = "PED_ACTION") %>% 
                      left_join(Collision_Type_Labels, by = "TYPE_OF_COLLISION") %>% 
                      left_join(Collision_Severity_Labels, by = "COLLISION_SEVERITY")
                                
```


# export cleaned sheet
```{r}
write.table(CollisionRecords, "CollisionRecordsCleaned.csv", row.names = FALSE, sep = ",")
```
